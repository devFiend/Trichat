<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" 
    integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" 
    crossorigin="anonymous" referrerpolicy="no-referrer">
    <title>Chat</title>
    <link rel="stylesheet" href="chat.css">
</head>
<body>
    <header class="header">
        <div class="nav">
            <div class="nav-profile">
                <a href="index.html"><i class="fa fa-arrow-left nav-left"></i></a>
                <div class="nav-profile-box-img">
                    <img src="testimonial-1.jpg" alt="">
                </div>
                <div class="nav-profile-box-text">
                    <h4>Treasure</h4>
                </div>
            </div>
        </div>
    </header>

    <section class="chatbox">
        <div class="chatbox-box">
            <div class="chatbox-box-content">
                <div class="chatbox-box-input">
                    <input type="text" class="messages" placeholder="Messages...">
                </div>
                <div class="chatbox-box-icon" id="sendBtn">
                    <i class="fa fa-paper-plane"></i>
                </div>                
            </div>
        </div>
    </section>

    <script>
        const params = new URLSearchParams(window.location.search);
        const otherUserId = params.get('userId');
        const otherUserName = params.get('name');
        const img = "testimonial-1.jpg";
    
        document.querySelector('.nav-profile-box-text h4').textContent = otherUserName;
        document.querySelector('.nav-profile-box-img img').src = img;
    
        const chatBox = document.querySelector('.chatbox-box');
        const sendBtn = document.getElementById('sendBtn');
        const input = document.querySelector('.messages');
    
        let loggedInUserId;
    
        // ✅ Attach click event FIRST
        sendBtn.addEventListener('click', () => {
            const msg = input.value.trim();
            if (!msg || !loggedInUserId) return;
    
            fetch('/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    senderId: loggedInUserId,
                    receiverId: otherUserId,
                    message: msg
                })
            }).then(res => {
                if (res.ok) {
                    input.value = '';
                    const msgDiv = document.createElement('div');
                    msgDiv.textContent = msg;
                    msgDiv.className = 'my-msg';
                    chatBox.appendChild(msgDiv);
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            }).catch(error => console.error('Error sending message:', error));
        });
    
        // ✅ Fetch user & chat history
       // ✅ Fetch user & chat history
fetch('/me')
    .then(res => res.json())
    .then(data => {
        // Check if user data exists, otherwise redirect to login
        if (!data.userId) {
            window.location.href = '/login.html';  // Redirect to login page
            return;
        }

        loggedInUserId = data.userId;

        // Fetch and display chat history
        fetch(`/messages/${otherUserId}`)
            .then(res => res.json())
            .then(messages => {
                messages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.textContent = msg.message;
                    msgDiv.className = msg.sender_id === loggedInUserId ? 'my-msg' : 'their-msg';
                    chatBox.appendChild(msgDiv);
                });
                chatBox.scrollTop = chatBox.scrollHeight; // Ensure chatbox scrolls to bottom
            })
            .catch(error => console.error('Error fetching messages:', error));
    })
    .catch(error => {
        console.error('Error getting logged-in user:', error);
        alert('Session expired. Please log in again.');
        window.location.href = '/login.html';  // Redirect to login page
    });
    </script>
     

</body>
</html>
